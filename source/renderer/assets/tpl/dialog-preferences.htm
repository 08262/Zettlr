<div class="dialog">
    <h1>%i18n.preferences.title%</h1>
    <form  action="" method="GET" id="dialog">
        <div id="prefs-tabs">
            <ul>
                <li><a href="#prefs-tabs-general">%i18n.preferences.general%</a></li>
                <li><a href="#prefs-tabs-editor">%i18n.preferences.editor%</a></li>
                <li><a href="#prefs-tabs-export">%i18n.preferences.export.title%</a></li>
                <li><a href="#prefs-tabs-attachments">%i18n.preferences.attachments%</a></li>
                <li><a href="#prefs-tabs-advanced">%i18n.preferences.advanced%</a></li>
            </ul>
            <!-- General settings -->
            <div id="prefs-tabs-general">
                <label for="app-lang">%i18n.preferences.app_lang.title%
                </label>
                <select name="app-lang" id="app-lang">
                    %APP_LANG%
                </select>
                <div>
                    <input type="checkbox" name="pref-darkTheme" value="yes" id="pref-darkTheme" %DARK%>
                    <label for="pref-darkTheme">%i18n.preferences.nightmode%</label>
                </div>
                <div>
                    <input type="checkbox" name="pref-snippets" value="yes" id="pref-snippets" %SNIPPETS%>
                    <label for="pref-snippets">%i18n.preferences.snippets%</label>
                </div>
                <hr>
                <p>
                    %i18n.preferences.combiner_explanation%
                </p>
                <div>
                    <input type="radio" name="pref-combiner-state" value="collapsed" id="pref-comb-state-coll" %COMBINER_COLLAPSED%>
                    <label for="pref-comb-state-coll">%i18n.preferences.combiner_collapsed%</label>
                </div>
                <div>
                    <input type="radio" name="pref-combiner-state" value="expanded" id="pref-comb-state-exp" %COMBINER_EXPANDED%>
                    <label for="pref-comb-state-exp">%i18n.preferences.combiner_expanded%</label>
                </div>
            </div>
            <!-- Editor related options -->
            <div id="prefs-tabs-editor">
                <div class="clear"></div>
                <div class="box-left">
                    <input type="text" class="dicts-list-search" placeholder="%i18n.preferences.spellcheck_search_placeholder%">
                    <ul class="dicts-list">
                        %AVAILABLE_DICTS%
                    </ul>
                </div>
                <div class="box-right">
                    <p>
                        %i18n.preferences.spellcheck%
                    </p>
                    <p>
                        %i18n.preferences.spellcheck_warning%
                    </p>
                    <hr>
                    <div class="selected-dictionaries">
                    %SPELLCHECK%
                </div>
                </div>
                <div class="clear"></div>
                <hr>
                <div>
                    <input type="checkbox" name="pref-mute-lines" value="yes" id="pref-mute-lines" %MUTE_LINES%>
                    <label for="pref-mute-lines">%i18n.preferences.mute_lines%</label>
                </div>
            </div>
            <!-- Export related options (except pandoc+xelatex) -->
            <div id="prefs-tabs-export">
                <p>
                    %i18n.preferences.export.dest%
                </p>
                <p>
                    <input type="radio" name="pref-export-dest" value="temp" id="pref-export-temp" %EXPORT_DEST_TEMP%>
                    <label for="pref-export-temp">%i18n.preferences.export.dest_temp_label%</label>
                </p>
                <p>
                    <input type="radio" name="pref-export-dest" value="cwd" id="pref-export-cwd" %EXPORT_DEST_CWD%>
                    <label for="pref-export-cwd">%i18n.preferences.export.dest_cwd_label%</label>
                </p>
                <hr>
                <div>
                    <p>%i18n.preferences.export.stripping%</p>
                    <p>
                        <input type="checkbox" name="pref-export-strip-id" value="yes" id="pref-export-strip-id" %EXPORT_STRIP_ID%>
                        <label for="pref-export-strip-id">%i18n.preferences.export.strip_id_label%</label>
                    </p>
                    <p>
                        <input type="checkbox" name="pref-export-strip-tags" value="yes" id="pref-export-strip-tags" %EXPORT_STRIP_TAGS%>
                        <label for="pref-export-strip-tags">%i18n.preferences.export.strip_tags_label%</label>
                    </p>
                    <p>
                        <input type="radio" name="pref-export-strip-links" value="full" id="pref-export-strip-link-full" %EXPORT_STRIP_LINKS_FULL%>
                        <label for="pref-export-strip-link-full">%i18n.preferences.export.strip_links_full_label%</label>
                    </p>
                    <p>
                        <input type="radio" name="pref-export-strip-links" value="unlink" id="pref-export-strip-link-unlink" %EXPORT_STRIP_LINKS_UNLINK%>
                        <label for="pref-export-strip-link-unlink">%i18n.preferences.export.strip_links_unlink_label%</label>
                    </p>
                    <p>
                        <input type="radio" name="pref-export-strip-links" value="no" id="pref-export-strip-link-no" %EXPORT_STRIP_LINKS_NO%>
                        <label for="pref-export-strip-link-no">%i18n.preferences.export.strip_links_no_label%</label>
                    </p>
                </div>
            </div>
            <!-- Attachment options -->
            <div id="prefs-tabs-attachments">
                <p>%i18n.preferences.attachments_info%</p>
                <textarea id="pref-attachments" name="pref-attachments">%ATTACHMENT_EXTENSIONS%</textarea>
            </div>
            <!-- Export/seldomly used options -->
            <div id="prefs-tabs-advanced">
                <label for="pref-pandoc">
                    %i18n.preferences.pandoc%
                </label>
                <input type="text" id="pref-pandoc" name="pref-pandoc" placeholder="%i18n.preferences.pandoc_default%" value="%PANDOC%">

                <label for="pref-xelatex">
                    %i18n.preferences.xelatex%
                </label>
                <input type="text" id="pref-xelatex" name="pref-xelatex" placeholder="%i18n.preferences.xelatex_default%" value="%XELATEX%">

                <hr>

                <div>
                    <input type="checkbox" name="debug" value="yes" id="debug" %DEBUG%>
                    <label for="debug">%i18n.preferences.debug%</label>
                </div>
            </div>
        </div>
        <div>
            <button type="submit" id="pref-save">%i18n.preferences.save%</button>
            <button id="abort">%i18n.preferences.cancel%</button>
        </div>
    </form>
</div>
<script type="text/javascript">
// Functions for the search field of the dictionary list.
$('.dicts-list-search').on('keyup', (e) => {
    let val = $('.dicts-list-search').val().toLowerCase();
    let list = $('.dicts-list').find('li').each(function(i) {
        if($(this).text().toLowerCase().indexOf(val) === -1) {
            $(this).hide();
        } else {
            $(this).show();
        }
    });
});

$('.dicts-list').on('click', (e) => {
    let elem = $(e.target);
    if(elem.is('li') && elem.hasClass('dicts-list-item')) {
        let selection = $(`<div class="selected-dict"><input type="hidden" value="${elem.attr('data-value')}" name="spellcheck[]" id="${elem.attr('data-value')}">${elem.text()}</div>`);
        $('.selected-dictionaries').append(selection);
        elem.detach();
        $('.dicts-list-search').val('').focus().trigger('keyup'); // Next search
    }
});

$('.selected-dictionaries').on('click', (e) => {
    let elem = $(e.target);
    if(elem.is('div') && elem.hasClass('selected-dict')) {
        let selection = $(`<li data-value="${elem.children('input').first().val()}" class="dicts-list-item">${elem.text()}</li>`);
        let length = $('.dicts-list').find('li').length;
        if(length == 0) {
            $('.dicts-list').append(selection);
        } else {
            $('.dicts-list').find('li').each(function(i) {
                if($(this).text() > elem.text()) {
                    selection.insertBefore($(this));
                    return false; // Break out of the loop
                } else if(i == length-1) {
                    selection.insertAfter($(this));
                }
            });
        }
        elem.detach();
    }
});
</script>
